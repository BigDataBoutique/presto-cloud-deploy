# Azure deployment

## Create the machine images with Packer

Go to the packer folder and see the README there. Once you have the machine image IDs, return here and continue with the next steps.

## Create key-pair or use your own

This deployment is configured to use your default SSH keys as machine credentials. If you want to use other keys, change the path to the keys you want to use (look for `key_path` in variables.tf). Use [this guide](https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/) to generate new keys if needed.

## Configurations

Edit `variables.tf` or create separate `terraform.tfvars` file to specify the following:

* `azure_location` - the Azure location where to launch the cluster in.
* `azure_subscription_id`, `azure_client_id`, `azure_client_secret`, `azure_tenant_id` - the same credentials used in the Packer step. See the README there for instructions on how to retrieve them.
* `presto_cluster` - the name of the Presto cluster to launch.
* `key_path` - the filesystem path to the SSH key to use as virtual machines login credentials.
* `coordinator_instance_type`, `worker_instance_type`, `client_instance_type` - Azure machine instance types to use for each machine type in the cluster.

The rest of the configurations are mostly around cluster topology and  machine types and sizes.

### Cluster topology

Two modes of deployment are supported:

* A recommended configuration, with dedicated coordinator node, worker nodes and client nodes. This is a production-ready and best-practice configuration.
* Coordinator+Worker node mode - mostly useful for experimentation

The default mode is the single-node mode. To change it to the recommended configuration, edit `variables.tf` and set number of worker and client nodes to at least 1.

All nodes with the `coordinator` and `client` role will be attached to an Azure load balancer, so access to all client nodes can be done via the DNS it exposes.

## Launch the cluster with Terraform

```bash
terraform plan
terraform apply
```

When terraform is done, you should see a lot of output ending with something like this:

```
Apply complete! Resources: 14 added, 0 changed, 0 destroyed.

The state of your infrastructure has been saved to the path
below. This state is required to modify and destroy your
infrastructure, so keep it safe. To inspect the complete state
use the `terraform show` command.

State path: terraform.tfstate

Outputs:

public_dns = presto-cluster-foo.eastus.cloudapp.azure.com
vm_password = rBTKoLsf7x8ODZVd
```

Note `clients_lb_public_ipaddress` and `vm-password` - that's your entry point to the cluster and the password for the `exampleuser` default user.

### Look around

The client nodes are the ones exposed to external networks. They provide endpoints for Kibana, Grafana, Cerebro and direct Presto access. By default client nodes are accessible via their public IPs and the DNS of the load balancer they are attached to (see above).

Client nodes listen on port 8080 and are password protected. Access is managed by nginx which is expecting a username and password pair. Default user name is exampleuser and the password is generated automatically when deploying. You can change those defaults by editing [this file](https://github.com/synhershko/presto-cloud-deploy/blob/master/packer/install-nginx.sh) and running Packer again.

On client nodes you will find:

* [Redash](https://redash.io) (data query / visualisation tool) is available on http://host:8500
* [Superset](https://superset.apache.org/) (data exploration platform) is available on http://host:8600
* [Zeppelin](https://zeppelin.apache.org/) (web-based data notebook) is available on http://host:8700

The default credentials are `admin` or `admin@redash` as username, and password as generated by Terraform during the deployment (will show up as `clients_password` after deployment when you run `terraform output`).

To ssh to one of the instances:

```bash
ssh ubuntu@{public IP / DNS of the instance or load balancer}
```

## Backups

The Azure repository plugin is installed on the cluster and ready to be used for index snapshots and (should you ever need) a restore.

### Auto- and manual- scale out

The entire stack is deployed using Azure scale-sets, which are easy to scale up and down manually (from the Azure portal, from the command line, or using the same Terraform scripts), or automatically based on host metrics and application metrics using [Azure scale-set features](https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview).

